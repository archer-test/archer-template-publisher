name: Iterate spec and publish to docs

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  contents: write

jobs:
  iterate_or_publish:
    if: github.event.comment.user.type != 'Bot'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Determine mode
        id: decide
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          set -euo pipefail
          NORMALIZED=$(echo "$COMMENT_BODY" | tr '[:upper:]' '[:lower:]' | xargs)
          if [ "$NORMALIZED" = "approved" ]; then
            echo "mode=approved" >> "$GITHUB_OUTPUT"
          else
            echo "mode=revise" >> "$GITHUB_OUTPUT"
          fi

      - name: Find spec comment
        id: find
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail

          COMMENTS=$(gh api "repos/$REPO/issues/$ISSUE_NUMBER/comments?per_page=100")

          SPEC_COMMENT_ID=$(echo "$COMMENTS" | jq -r '
            .[] | select(.body | contains("<!-- spec_comment_id:")) | .id
          ' | head -n 1)

          if [ -z "$SPEC_COMMENT_ID" ] || [ "$SPEC_COMMENT_ID" = "null" ]; then
            echo "No spec comment found. Exiting."
            exit 0
          fi

          echo "spec_comment_id=$SPEC_COMMENT_ID" >> "$GITHUB_OUTPUT"

      - name: "Revise spec comment"
        if: steps.decide.outputs.mode == 'revise'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          SPEC_COMMENT_ID: ${{ steps.find.outputs.spec_comment_id }}
          USER_FEEDBACK: ${{ github.event.comment.body }}
        run: |
          set -euo pipefail

          ISSUE=$(gh api "repos/$REPO/issues/$ISSUE_NUMBER")
          TITLE=$(echo "$ISSUE" | jq -r '.title')
          BODY=$(echo "$ISSUE" | jq -r '.body // ""')

          SPEC_COMMENT=$(gh api "repos/$REPO/issues/comments/$SPEC_COMMENT_ID")
          CURRENT_SPEC=$(echo "$SPEC_COMMENT" | jq -r '.body')

          # NOTE: EOF terminators MUST be at column 1 (no leading spaces)
          cat > /tmp/prompt.txt <<'EOF'
          You are a senior engineer. You previously wrote a spec comment for a GitHub issue.
          Revise the spec based on the user's feedback below.

          Rules:
          - Keep the same structure.
          - Incorporate feedback precisely.
          - If feedback is unclear, add clarifying questions in "Open questions".
          Return Markdown only.
          EOF

                    cat > /tmp/input.txt <<EOF
          Issue title:
          $TITLE

          Issue body:
          $BODY

          User feedback:
          $USER_FEEDBACK

          Current spec:
          $CURRENT_SPEC
          EOF

          PROMPT="$(cat /tmp/prompt.txt)"
          INPUT="$(cat /tmp/input.txt)"

          RESPONSE=$(curl -sS https://api.openai.com/v1/responses \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg model "gpt-5.2" --arg input "$PROMPT"$'\n\n'"$INPUT" '{model:$model,input:$input}')")


          NEW_SPEC=$(echo "$RESPONSE" | jq -r '.output_text')
          if [ -z "$NEW_SPEC" ] || [ "$NEW_SPEC" = "null" ]; then
            echo "OpenAI returned no output"
            echo "$RESPONSE"
            exit 1
          fi

          UPDATED_BODY=$(cat <<EOF
          <!-- spec_comment_id:$SPEC_COMMENT_ID -->
          ðŸ‘‹ Updated spec based on feedback. Reply **approved** when ready.

          ---

          $NEW_SPEC
          EOF
          )

          gh api -X PATCH "repos/$REPO/issues/comments/$SPEC_COMMENT_ID" \
            -f body="$UPDATED_BODY"

      - name: Create docs spec and PR
        if: steps.decide.outputs.mode == 'approved'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          SPEC_COMMENT_ID: ${{ steps.find.outputs.spec_comment_id }}
        run: |
          set -euo pipefail

          ISSUE=$(gh api "repos/$REPO/issues/$ISSUE_NUMBER")
          TITLE=$(echo "$ISSUE" | jq -r '.title')

          SLUG=$(echo "$TITLE" \
            | tr '[:upper:]' '[:lower:]' \
            | sed -E 's/[^a-z0-9]+/-/g' \
            | sed -E 's/^-+|-+$//g')

          SPEC_COMMENT=$(gh api "repos/$REPO/issues/comments/$SPEC_COMMENT_ID")
          SPEC_BODY=$(echo "$SPEC_COMMENT" | jq -r '.body')

          mkdir -p docs
          FILE=$(printf "docs/%03d-%s.md" "$ISSUE_NUMBER" "$SLUG")

          CLEAN_SPEC=$(echo "$SPEC_BODY" | sed '1{/^<!-- spec_comment_id:/d}')

          cat > "$FILE" <<EOF
# Spec: $TITLE

        Source issue: $REPO#$ISSUE_NUMBER

          $CLEAN_SPEC
          EOF

          BRANCH="spec/${ISSUE_NUMBER}-${SLUG}"
          git checkout -b "$BRANCH"
          git add "$FILE"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
    git commit -m docs: "add spec for #$ISSUE_NUMBER"
    git push origin "$BRANCH" \

    gh pr create \
    --base main \
    --head "$BRANCH" \
    --title docs: "spec for #$ISSUE_NUMBER" \
    --body "Adds an approved spec for issue #$ISSUE_NUMBER."
