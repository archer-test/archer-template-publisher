name: Iterate spec and publish to docs on approval

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  contents: write

jobs:
  iterate_or_publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Decide action (revise vs approved)"
        id: decide
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          set -euo pipefail
          normalized=$(echo "$COMMENT_BODY" | tr '[:upper:]' '[:lower:]' | xargs)
          if [ "$normalized" = "approved" ]; then
            echo "mode=approved" >> "$GITHUB_OUTPUT"
          else
            echo "mode=revise" >> "$GITHUB_OUTPUT"
          fi

      - name: "Fetch issue + find spec comment id"
        id: fetch
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail

          # Get all comments and find our marker
          COMMENTS=$(gh api "repos/$REPO/issues/$ISSUE_NUMBER/comments?per_page=100")
          SPEC_ID=$(echo "$COMMENTS" | jq -r '
            .[] | select(.body | contains("<!-- spec_comment_id:")) | .body
            ' | head -n 1 | sed -n 's/.*<!-- spec_comment_id:\([0-9]\+\) -->.*/\1/p')

          if [ -z "$SPEC_ID" ]; then
            echo "No spec marker comment found. Exiting."
            exit 0
          fi

          echo "spec_comment_id=$SPEC_ID" >> "$GITHUB_OUTPUT"

      - name: "Revise spec comment"
        if: steps.decide.outputs.mode == 'revise'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          USER_FEEDBACK: ${{ github.event.comment.body }}
          SPEC_COMMENT_ID: ${{ steps.fetch.outputs.spec_comment_id }}
        run: |
          set -euo pipefail

          ISSUE=$(gh api "repos/$REPO/issues/$ISSUE_NUMBER")
          TITLE=$(echo "$ISSUE" | jq -r '.title')
          BODY=$(echo "$ISSUE" | jq -r '.body // ""')

          SPEC_COMMENT=$(gh api "repos/$REPO/issues/comments/$SPEC_COMMENT_ID")
          CURRENT_SPEC=$(echo "$SPEC_COMMENT" | jq -r '.body')

          PROMPT=$(cat <<'EOF'
You are a senior engineer. You previously wrote a spec comment for a GitHub issue.
Revise the spec based on the user's feedback below.

Rules:
- Keep the same structure (Summary, Goals, Non-goals, Architecture/Approach, Implementation steps, Tech, Edge cases, Testing plan, Rollout, Open questions)
- Incorporate feedback precisely.
- If feedback is unclear, add clarifying questions in "Open questions".
Return Markdown only.
EOF
)

          INPUT=$(cat <<EOF
Issue title: $TITLE
Issue body:
$BODY

User feedback comment:
$USER_FEEDBACK

Current spec comment (may include an HTML marker at top):
$CURRENT_SPEC
EOF
)

          RESP=$(curl -sS https://api.openai.com/v1/responses \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$(jq -n --arg model "gpt-5.2" --arg input "$PROMPT"$'\n\n'"$INPUT" '{model:$model,input:$input}')" )

          NEW_SPEC=$(echo "$RESP" | jq -r '.output_text')
          if [ -z "$NEW_SPEC" ] || [ "$NEW_SPEC" = "null" ]; then
            echo "OpenAI response missing output_text"
            echo "$RESP"
            exit 1
          fi

          # Preserve marker line if present
          MARKER=$(echo "$CURRENT_SPEC" | head -n 1 | grep -E '^<!-- spec_comment_id:' || true)
          if [ -z "$MARKER" ]; then
            MARKER="<!-- spec_comment_id:$SPEC_COMMENT_ID -->"
          fi

          UPDATED=$(cat <<EOF
$MARKER
ðŸ‘‹ Updated spec based on feedback. Reply **approved** when ready, or leave more comments.

---

$NEW_SPEC
EOF
)

          gh api -X PATCH "repos/$REPO/issues/comments/$SPEC_COMMENT_ID" \
            -f body="$UPDATED"

      - name: "Create docs spec + PR on approval"
        if: steps.decide.outputs.mode == 'approved'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          SPEC_COMMENT_ID: ${{ steps.fetch.outputs.spec_comment_id }}
        run: |
          set -euo pipefail

          ISSUE=$(gh api "repos/$REPO/issues/$ISSUE_NUMBER")
          TITLE=$(echo "$ISSUE" | jq -r '.title')
          SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g' | sed -E 's/^-+|-+$//g')

          SPEC_COMMENT=$(gh api "repos/$REPO/issues/comments/$SPEC_COMMENT_ID")
          SPEC_BODY=$(echo "$SPEC_COMMENT" | jq -r '.body')

          # Create docs filename: 001-<slug>.md
          # We'll use the issue number as a stable numeric prefix (e.g. 123-...).
          mkdir -p docs
          FILENAME=$(printf "%03d-%s.md" "$ISSUE_NUMBER" "$SLUG")
          PATH_OUT="docs/$FILENAME"

          # Strip marker line if present
          CLEAN=$(echo "$SPEC_BODY" | sed '1{/^<!-- spec_comment_id:/d}')

          cat > "$PATH_OUT" <<EOF
# Spec: $TITLE

Source: $REPO#$ISSUE_NUMBER

$CLEAN
EOF

          BR="spec/${ISSUE_NUMBER}-${SLUG}"
          git checkout -b "$BR"
          git add "$PATH_OUT"
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "docs: add spec for #$ISSUE_NUMBER"

          git push origin "$BR"

          gh pr create \
            --base main \
            --head "$BR" \
            --title "docs: spec for #$ISSUE_NUMBER" \
            --body "Adds an approved spec for issue #$ISSUE_NUMBER."
