name: Draft spec on issue open

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  draft_spec:
    runs-on: ubuntu-latest
    steps:
      - name: "Generate spec and comment"
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          # Build prompt
          PROMPT=$(cat <<'EOF'
You are a senior engineer. Write a detailed implementation spec for the GitHub issue below.

Requirements:
- Start with a short "Summary"
- Include "Goals" and "Non-goals"
- Include an "Architecture / Approach" section
- Include "Implementation steps" as a numbered checklist
- Include "Necessary technologies / libraries" (be concrete)
- Include "Edge cases"
- Include "Testing plan"
- Include "Rollout / migration plan" if relevant
- Include "Open questions" if any

Write in Markdown. Be specific and actionable.
EOF
)
          ISSUE_CONTEXT=$(cat <<EOF
Repository: $REPO
Issue #$ISSUE_NUMBER: $ISSUE_TITLE

Body:
$ISSUE_BODY
EOF
)

          # Call OpenAI Responses API (recommended for new projects) :contentReference[oaicite:1]{index=1}
          RESP=$(curl -sS https://api.openai.com/v1/responses \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$(jq -n \
              --arg model "gpt-5.2" \
              --arg input "$PROMPT"$'\n\n'"$ISSUE_CONTEXT" \
              '{model:$model, input:$input}')" )

          SPEC=$(echo "$RESP" | jq -r '.output_text')
          if [ -z "$SPEC" ] || [ "$SPEC" = "null" ]; then
            echo "OpenAI response missing output_text"
            echo "$RESP"
            exit 1
          fi

          BODY=$(cat <<EOF
ðŸ‘‹ I drafted a spec for this issue. Please review and reply with comments.  
When you're satisfied, reply **approved** and I'll open a PR that adds the spec to \`docs/\`.

---

$SPEC
EOF
)

          # Post comment
          COMMENT=$(gh api \
            -X POST "repos/$REPO/issues/$ISSUE_NUMBER/comments" \
            -f body="$BODY")

          COMMENT_ID=$(echo "$COMMENT" | jq -r '.id')
          echo "Spec comment id: $COMMENT_ID"

          # Store state via issue label + comment id in a hidden HTML marker
          # (Weâ€™ll look for this marker later to edit the same comment.)
          MARKER="<!-- spec_comment_id:$COMMENT_ID -->"

          gh api -X PATCH "repos/$REPO/issues/$ISSUE_NUMBER/comments/$COMMENT_ID" \
            -f body="$MARKER"$'\n'"$BODY"
